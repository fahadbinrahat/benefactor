"use strict";angular.module("cba.wizard",[]),angular.module("cba.wizard").controller("CbaWizardController",["$scope","$element","TypeformTransitionProvider","DefaultWorkflowProvider","$timeout","$q",function(a,b,c,d,e,f){function g(a,b){angular.forEach(a,function(a){a(b)})}var h,i,j,k={},l=this,m={onStepAdded:[],onStepRemoved:[],onStepLeave:[],onStepEnter:[],onStart:[],onSubmit:[]},n={disableWhenInactive:!1};this.init=function(e,f){function g(b,c){function d(b,c){a.$eval(b,c)}angular.forEach(m,function(a,e){angular.isFunction(i[e])&&a.push(angular.bind(i,i[e])),angular.isFunction(h[e])&&a.push(angular.bind(h,h[e]));var f=e[0].toUpperCase()+e.substring(1);angular.isFunction(b[e])?a.push(b[e]):c["cbaWizard"+f]&&a.push(angular.bind(l,d,c["cbaWizard"+f]))})}function j(e){n=angular.extend(n,e),h=e.transitionProvider||new c,i=e.workflowProvider||new d,i.init(l,b),h.init(l,b),n.progress=n.progress||f.cbaWizardProgress,n.progress&&(a[n.progress]=0)}return j(e,f),g(e,f),this},this.getOptions=function(){return n},this.start=function(){g(m.onStart);var a=i.getFirstStep();return a&&k[a]&&(k[a].controller.setActive(!0),j=a),this},this.updateProgress=function(){return i&&(a[n.progress]=i.getProgress(j)),this},this.registerStep=function(a){return k[a.id]?this:(k[a.id]=a,this.updateProgress(),g(m.onStepAdded,{step:a.id,steps:k}),this)},this.removeStep=function(a){return delete k[a],this.updateProgress(),e(function(){g(m.onStepRemoved,{step:a,steps:k})}),this},this.next=function(){var a=this;return e(function(){var b=i.getNextStep(j);b&&a.setActiveStep(b,{event:"next",requiresFocus:!0})}),this},this.previous=function(){var a=this;return e(function(){var b=i.getPreviousStep(j);b&&a.setActiveStep(b,{event:"previous",requiresFocus:!0})}),this},this.scrollToCurrentStep=function(a){h.performTransition(j,j,k,a)},this.setActiveStep=function(a,b){var c=this,d=b&&b.force;if(!k[a]||k[a].controller.isActive()&&!d)return f.when(!0);if(g(m.onStepLeave,{step:j,event:b}),k[j]&&k[j].controller.setActive(!1),!h||!angular.isFunction(h.performTransition))throw new Error("There is no transition manager set up to perform wizard step transitions");return h.performTransition(j,a,k,b).then(function(){g(m.onStepEnter,{step:a,event:b}),k[a].controller.setActive(!0,b),j=a,c.updateProgress()})},this.submit=function(){var a=b.controller("form");angular.forEach(k,function(a){a.controller.validate()}),this.updateProgress(),g(m.onSubmit,{isValid:a.$valid})}}]).directive("cbaWizard",["lazyContentHelper",function(a){return{require:["cbaWizard","form"],controllerAs:"wizardCtrl",controller:"CbaWizardController",link:{pre:function(a,b,c,d){var e=c.cbaWizard?a.$eval(c.cbaWizard):{},f=d[0];f.init(e,c)},post:function(b,c,d,e){var f=e[0];a.awaitContentLoaded(b).then(function(){f.start()}),c.on("focus.wizard.cba",".wizard-step-inactive",function(){f.setActiveStep($(this).attr("id"),{event:"focus",requiresFocus:!1}),b.$apply()}).on("$destroy",function(){c.off("focus.wizard.cba",".wizard-step-inactive")})}}}}]),angular.module("cba.wizard").directive("cbaWizardButton",function(){return{require:["^cbaWizardStep","^cbaWizard"],link:function(a,b,c,d){function e(b){a.$apply(function(){var a=c.type?c.type.toLowerCase():"",b=f.next();b?"submit"===a&&g.submit():f.focusFirstError()}),h.is('[type="checkbox"],[type="radio"]')||b.preventDefault()}var f=d[0],g=d[1],h=b.is("label")?$("#"+b.attr("for")):b;b.on("click",e).on("$destroy",function(){b.off("click",e)})}}}),angular.module("cba.wizard").controller("CbaWizardStepController",["$scope","$attrs","$element",function(a,b,c){var d,e,f;this.init=function(a,b){return d=a,e=b,f=e.getOptions(),this},this.isValid=function(){return d.$valid},this.isActive=function(){return a.isStepActive},this.setActive=function(d){return a.isStepActive&&!d&&b.stepLeave?a.$eval(b.stepLeave):!a.isStepActive&&d&&b.stepEnter&&a.$eval(b.stepEnter),a.isStepActive=d,f.disableWhenInactive&&0===c.prop("tagName").search(/fieldset/i)&&c.prop("disabled",!d),this},this.getProgressWeighting=function(){return b.progressWeight?Number(b.progressWeight):10},this.next=function(){var a=this.validate();return a&&e.next(),a},this.validate=function(){return d.$setDirty(),angular.forEach(d,function(a,b){if("$"!==b.substring(0,1)){var c=d[b];!c.$dirty&&c.$setViewValue&&c.$setViewValue(c.$viewValue)}}),d.$valid},this.focusFirstError=function(){d.$invalid&&c.find(".ng-invalid:input:visible:first").focus()}}]).directive("cbaWizardStep",function(){var a={overlay:'<div class="wizard-overlay">',activeClasses:"data-ng-class=\"{'wizard-step-active': isStepActive, 'wizard-step-inactive': !isStepActive}\" "};return{require:["cbaWizardStep","^cbaWizard","form"],controller:"CbaWizardStepController",controllerAs:"wizardStepCtrl",transclude:!0,scope:!0,replace:!0,template:function(b,c){var d=b[0].nodeName,e=c.ngForm?"":"data-ng-form";return"<"+d+" "+a.activeClasses+e+"></"+d+">"},link:function(b,c,d,e,f){function g(a){if(13===a.keyCode){var b=$(a.target);if(!b.is("a")&&!b.is("[data-cba-wizard-ignore-enter]")&&0===b.parents("[data-cba-wizard-ignore-enter]").length){var d="[data-cba-wizard-button], [cba-wizard-button], [data-cba-wizard-button-with-click], [cba-wizard-button-with-click]";b.is(d)||0!==b.parents(d).length||($("[data-cba-wizard-button], [cba-wizard-button]",c).click(),a.preventDefault())}}}var h=e[0],i=e[1],j=e[2];if(!d.id||""===d.id)throw new Error('Wizard step must have an id set eg) id="step1"');f(b,function(a){c.append(a)}),b.form=j,h.init(j,i).setActive(!1),i.registerStep({id:d.id,controller:h,element:c}),c.addClass("wizard-step wizard-step-inactive").append(a.overlay).on("keydown",g).on("$destroy",function(){i&&(i.removeStep(d.id),c.off("keydown",g))})}}}),angular.module("cba.wizard").factory("DefaultWorkflowProvider",["$timeout",function(a){function b(a){var b=0,c=0;return angular.forEach(a,function(a){var d=a.controller.getProgressWeighting();b+=d,a.controller.isValid()&&(c+=d)}),Math.floor(c/b*100)}function c(a,b){var c=0,d=0;return angular.forEach(a,function(a,e){b===e&&(d=c),c+=a.controller.getProgressWeighting()}),Math.floor(d/c*100)}function d(a){function b(){var a=1;angular.forEach(d.DOMCache,function(b){var c=angular.element(b);if(c.is(":visible")){var d=a++%2===0;c.toggleClass("odd",!d).toggleClass("even",d)}})}function c(a){d.DOMCache=d.element.find(d.options.stepSelector),d.wizardSteps=a.steps,b()}var d=this,e={goToErrorOnSubmit:!0,stepSelector:"[data-cba-wizard-step], [cba-wizard-step]",skipValidStepsAfterSubmit:!0,progressShowsValidSteps:!0};this.options=angular.extend(e,a),this.hasBeenSubmitted=!1,this.onStepAdded=function(a){c(a)},this.onStepRemoved=function(a){c(a)}}return d.prototype.init=function(a,b){this.element=b,this.wizardCtrl=a,this.wizardSteps=[],this.DOMCache=[]},d.prototype.getProgress=function(a){return this.options.progressShowsValidSteps?b(this.wizardSteps):c(this.wizardSteps,a)},d.prototype.getFirstStep=function(){var a=this.options.firstElement?this.element.find(this.options.firstElement).parents(this.options.stepSelector):this.element.find(this.options.stepSelector);return 0===a.length?null:a.first().attr("id")},d.prototype.getNextStep=function(a){var b,c,d=null,e=null,f=this.element.find(this.options.stepSelector);for(c=0;c<f.length;c++)if(b=f[c],b.id===a)e=c;else if(null!==e){if(d=b.id,this.wizardSteps[d].controller.isValid()&&this.options.submitIfNextStepIsValid)return this.wizardCtrl.submit(),null;if(!this.wizardSteps[d].controller.isValid()||!this.options.skipValidStepsAfterSubmit||!this.hasBeenSubmitted)return d}return d},d.prototype.getPreviousStep=function(a){for(var b,c=0,d=0,e=this.element.find(this.options.stepSelector);c<e.length;c++)if(b=e[c],d=c-1,b.id===a)return d>=0?e[d].id:null;return null},d.prototype.onStart=function(){if(this.options.firstElement){var b=this;a(function(){b.element.find(b.options.firstElement).focus()})}},d.prototype.onSubmit=function(a){var b=null,c=this;return c.hasBeenSubmitted=!0,!a.isValid&&this.options.goToErrorOnSubmit?(this.DOMCache.each(function(){return c.wizardSteps[this.id].controller.isValid()?void 0:(b=this.id,!1)}),null===b&&(b=this.DOMCache[this.DOMCache.length-1].id),c.wizardCtrl.setActiveStep(b,{event:"invalid",requiresFocus:!0})):void 0},d}]),angular.module("cba.wizard").factory("lazyContentHelper",["$q","$timeout",function(a,b){function c(c){function d(){i||(b.cancel(g),g=b(function(){0>=h&&(i=!0,j.resolve())}))}function e(){--h<=0&&d()}function f(){h++}var g,h=0,i=!1,j=a.defer();return c.$on("$includeContentRequested",f),c.$on("$includeContentLoaded",e),c.$on("$includeContentError",e),b(d),j.promise}return{awaitContentLoaded:c}}]),angular.module("cba.wizard").factory("TypeformTransitionProvider",["$window","$timeout","$q",function(a,b,c){var d={event:"scroll",requiresFocus:!0},e=angular.element(a),f=function(){var a,b=$("<div>Test</div>");return b.css({minHeight:100,paddingTop:10,paddingBottom:10,position:"absolute",top:-2e3}),$("body").append(b),a=b[0].scrollHeight,b.remove(),120===a}(),g=function(c){function g(){s.DOMCache=[],s.timer=null,s.isAnimating=!1,s.options=angular.copy(r),angular.extend(s.options,c),s.isDocumentLevelContainer=null===s.options.scrollContainer,s.options.scrollContainer=s.options.scrollContainer||$("html, body"),s.options.viewport=s.options.viewport||e,s.scrollHandlerElement=s.isDocumentLevelContainer?e:s.options.scrollContainer,s.onStepAdded=i,s.onStepRemoved=j,s.onStart=j,s.destroy=q,s.forceResize=o,s.options.scrollContainer.removeClass(s.options.animatingClass),s.options.scrollContainer.addClass(s.options.idleClass)}function h(){if(s.scrollHandlerElement.bind("scroll wheel",k),s.options.resizeSteps){var a;$("body").on("focus touchstart",":input",function(){a&&clearTimeout(a),a=setTimeout(function(){a=null},1e3)}),e.bind("resize orientationchange",function(){a||l()})}}function i(a){j(),n(a.steps[a.step].element)}function j(){s.DOMCache=s.element.find(s.options.stepSelector)}function k(a){"wheel"===a.type&&s.options.scrollContainer.finish(),s.timer&&(b.cancel(s.timer),s.timer=null);var c=$(this);s.timer=b(function(){p(c.scrollTop()),b.cancel(s.timer),s.timer=null},s.options.scrollThrottleMs)}function l(){m()||o()}function m(){return s.options.viewport.width()<s.options.bp2Min}function n(a){b(function(){var b=m()?1:s.options.bp2ViewportFraction,c=angular.element(a);if(!c.hasClass("no-resize")&&c.is(":visible")){var d=c.height(),e=s.options.viewport.height()*b,g=(e-d)/2,h=g,i=g,j=f?e-2*g:e;h=Math.max(s.options.minPadding,h),i=Math.max(s.options.minPadding,i),c.css({paddingTop:h+"px",paddingBottom:i+"px",minHeight:j})}})}function o(){angular.forEach(s.DOMCache,n)}function p(b){function c(){return g-b<=s.options.bottomGutter}function e(){return b-s.options.topGutter<=0}function f(a){var c=s.isDocumentLevelContainer?a.position().top:a.position().top+b;return h>c&&c+a.outerHeight()>h}var g=s.options.scrollContainer[0].scrollHeight||$(document).height()-$(a).height(),h=.5*s.options.viewport.height()+b,i=s.wizardController;s.isAnimating||(c()?i.setActiveStep(s.DOMCache[s.DOMCache.length-1],d):e()?i.setActiveStep(s.DOMCache[0].id,d):$.each(s.DOMCache,function(){return f($(this))?(i.setActiveStep(this.id,d),!1):void 0}))}function q(){s.scrollHandlerElement.off("scroll",k)}var r={resizeSteps:!0,focusFirstError:!0,scrollSpeed:400,bottomGutter:0,topGutter:30,bp2Min:600,minPadding:40,scrollThrottleMs:200,stepSelector:"[data-cba-wizard-step], [cba-wizard-step]",viewport:null,scrollContainer:null,bp2ViewportFraction:.6,idleClass:"typeform-transition-idle",animatingClass:"typeform-transition-animating"},s=this;g(),h()};return g.fn=g.prototype,g.fn.init=function(a,b){this.wizardController=a,this.element=b},g.fn.performTransition=function(a,b,d,e){function f(a){i.isAnimating=a,a?(i.options.scrollContainer.removeClass(i.options.idleClass),i.options.scrollContainer.addClass(i.options.animatingClass)):(i.options.scrollContainer.removeClass(i.options.animatingClass),i.options.scrollContainer.addClass(i.options.idleClass))}function g(){!e.requiresFocus||"ontouchstart"in document.documentElement||(!k.controller.isValid()&&i.options.focusFirstError?k.controller.focusFirstError():"false"!==k.element.attr("focus")&&k.element.find(":input:visible:enabled:first").focus()),f(!1),j.resolve()}function h(a,b){return b>a?0:(a-b)/2}var i=this,j=c.defer(),k=d[b];if(this.isAnimating)return c.when(!0);f(!0);var l=h(i.options.viewport.height(),k.element.outerHeight()),m=k.element.position().top+i.options.scrollContainer.scrollTop()-l;return i.isDocumentLevelContainer&&(m=k.element.offset().top-l),"bottom"===e.align?this.options.scrollContainer.animate({scrollTop:m+i.options.viewport.height()},this.options.scrollSpeed,g):this.options.scrollContainer.animate({scrollTop:m},this.options.scrollSpeed,g),j.promise},g}]);